{% extends "base.html" %}

{% block title %}Analytics - Strava Race Predictor{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
            Training Analytics
        </h1>
        <p class="text-gray-600">Deep dive into your running patterns and performance trends</p>
    </div>

    <!-- Training Volume Over Time -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4 text-gray-900">
            <i class="fas fa-chart-line text-blue-500 mr-2"></i>
            Monthly Training Volume
        </h2>
        <div id="volume-chart" style="height: 400px;"></div>
    </div>

    <!-- Pace Distribution -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900">
                <i class="fas fa-tachometer-alt text-green-500 mr-2"></i>
                Pace Distribution
            </h2>
            <div id="pace-chart" style="height: 350px;"></div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-900">
                <i class="fas fa-calendar-week text-orange-500 mr-2"></i>
                Runs by Day of Week
            </h2>
            <div id="day-chart" style="height: 350px;"></div>
        </div>
    </div>

    <!-- Hour of Day Analysis -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4 text-gray-900">
            <i class="fas fa-clock text-purple-500 mr-2"></i>
            Preferred Running Times
        </h2>
        <div id="hour-chart" style="height: 350px;"></div>
    </div>

    <!-- Additional Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Longest Run</h3>
                <i class="fas fa-medal text-3xl opacity-50"></i>
            </div>
            <p id="longest-run" class="text-4xl font-bold">-</p>
            <p class="text-sm opacity-75 mt-1">kilometers</p>
        </div>

        <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Best Pace</h3>
                <i class="fas fa-bolt text-3xl opacity-50"></i>
            </div>
            <p id="best-pace" class="text-4xl font-bold">-</p>
            <p class="text-sm opacity-75 mt-1">min/km</p>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Running Since</h3>
                <i class="fas fa-calendar-alt text-3xl opacity-50"></i>
            </div>
            <p id="first-run" class="text-2xl font-bold">-</p>
            <p class="text-sm opacity-75 mt-1">first recorded run</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load stats
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('longest-run').textContent = data.longest_run_km;
            document.getElementById('best-pace').textContent = data.best_pace;
            document.getElementById('first-run').textContent = data.first_run_date;
        });

    // Load training trends
    fetch('/api/training_trends')
        .then(response => response.json())
        .then(data => {
            const months = data.map(d => d.month);
            const distances = data.map(d => d.distance_km);
            const numRuns = data.map(d => d.num_runs);

            const trace1 = {
                x: months,
                y: distances,
                name: 'Distance (km)',
                type: 'bar',
                marker: {color: '#8b5cf6'}
            };

            const trace2 = {
                x: months,
                y: numRuns,
                name: 'Number of Runs',
                type: 'scatter',
                mode: 'lines+markers',
                yaxis: 'y2',
                marker: {color: '#3b82f6', size: 8},
                line: {width: 3}
            };

            const layout = {
                title: '',
                xaxis: {title: 'Month'},
                yaxis: {title: 'Distance (km)'},
                yaxis2: {
                    title: 'Number of Runs',
                    overlaying: 'y',
                    side: 'right'
                },
                showlegend: true,
                legend: {x: 0, y: 1.1, orientation: 'h'}
            };

            Plotly.newPlot('volume-chart', [trace1, trace2], layout, {responsive: true});
        });

    // Load pace distribution
    fetch('/api/pace_distribution')
        .then(response => response.json())
        .then(data => {
            const trace = {
                x: data.paces,
                type: 'histogram',
                nbinsx: 30,
                marker: {color: '#10b981'},
                name: 'Pace Distribution'
            };

            const layout = {
                title: '',
                xaxis: {title: 'Pace (min/km)'},
                yaxis: {title: 'Frequency'},
                shapes: [
                    {
                        type: 'line',
                        x0: data.mean,
                        y0: 0,
                        x1: data.mean,
                        y1: 1,
                        yref: 'paper',
                        line: {color: '#ef4444', width: 2, dash: 'dash'}
                    },
                    {
                        type: 'line',
                        x0: data.median,
                        y0: 0,
                        x1: data.median,
                        y1: 1,
                        yref: 'paper',
                        line: {color: '#3b82f6', width: 2, dash: 'dash'}
                    }
                ],
                annotations: [
                    {
                        x: data.mean,
                        y: 1,
                        yref: 'paper',
                        text: `Mean: ${data.mean.toFixed(2)}`,
                        showarrow: false,
                        yshift: 10
                    },
                    {
                        x: data.median,
                        y: 0.9,
                        yref: 'paper',
                        text: `Median: ${data.median.toFixed(2)}`,
                        showarrow: false,
                        yshift: 10
                    }
                ]
            };

            Plotly.newPlot('pace-chart', [trace], layout, {responsive: true});
        });

    // Load weekly patterns
    fetch('/api/weekly_patterns')
        .then(response => response.json())
        .then(data => {
            // Day of week chart
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayCounts = days.map(day => data.by_day[day] || 0);

            const dayTrace = {
                x: days,
                y: dayCounts,
                type: 'bar',
                marker: {
                    color: dayCounts,
                    colorscale: 'Viridis'
                }
            };

            const dayLayout = {
                title: '',
                xaxis: {title: 'Day of Week'},
                yaxis: {title: 'Number of Runs'}
            };

            Plotly.newPlot('day-chart', [dayTrace], dayLayout, {responsive: true});

            // Hour of day chart
            const hours = Array.from({length: 24}, (_, i) => i);
            const hourCounts = hours.map(hour => data.by_hour[hour] || 0);
            const hourLabels = hours.map(h => `${String(h).padStart(2, '0')}:00`);

            const hourTrace = {
                x: hourLabels,
                y: hourCounts,
                type: 'bar',
                marker: {
                    color: hourCounts,
                    colorscale: 'Portland'
                }
            };

            const hourLayout = {
                title: '',
                xaxis: {title: 'Hour of Day'},
                yaxis: {title: 'Number of Runs'}
            };

            Plotly.newPlot('hour-chart', [hourTrace], hourLayout, {responsive: true});
        });
</script>
{% endblock %}
